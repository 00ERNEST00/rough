var RoughCanvas=function(){'use strict';function a(){return{LEFT:0,RIGHT:1,INTERSECTS:2,AHEAD:3,BEHIND:4,SEPARATE:5,UNDEFINED:6}}var b=Math.tan,c=Math.sin,d=Math.cos,e=Math.PI,f=Math.sqrt,g=Math.max,h=Math.min,i=Math.abs,j=Number.MAX_VALUE;class k{constructor(b,c,d,e){this.RoughSegmentRelationConst=a(),this.px1=b,this.py1=c,this.px2=d,this.py2=e,this.xi=j,this.yi=j,this.a=e-c,this.b=b-d,this.c=d*c-b*e,this._undefined=0==this.a&&0==this.b&&0==this.c}isUndefined(){return this._undefined}compare(d){if(this.isUndefined()||d.isUndefined())return this.RoughSegmentRelationConst.UNDEFINED;var e=j,f=j,k=0,l=0,m=this.a,n=this.b,b=this.c;return(1e-5<i(n)&&(e=-m/n,k=-b/n),1e-5<i(d.b)&&(f=-d.a/d.b,l=-d.c/d.b),e==j)?f==j?-b/m==-d.c/d.a?this.py1>=h(d.py1,d.py2)&&this.py1<=g(d.py1,d.py2)?(this.xi=this.px1,this.yi=this.py1,this.RoughSegmentRelationConst.INTERSECTS):this.py2>=h(d.py1,d.py2)&&this.py2<=g(d.py1,d.py2)?(this.xi=this.px2,this.yi=this.py2,this.RoughSegmentRelationConst.INTERSECTS):this.RoughSegmentRelationConst.SEPARATE:this.RoughSegmentRelationConst.SEPARATE:(this.xi=this.px1,this.yi=f*this.xi+l,-1e-5>(this.py1-this.yi)*(this.yi-this.py2)||-1e-5>(d.py1-this.yi)*(this.yi-d.py2)?this.RoughSegmentRelationConst.SEPARATE:1e-5>i(d.a)?-1e-5>(d.px1-this.xi)*(this.xi-d.px2)?this.RoughSegmentRelationConst.SEPARATE:this.RoughSegmentRelationConst.INTERSECTS:this.RoughSegmentRelationConst.INTERSECTS):f==j?(this.xi=d.px1,this.yi=e*this.xi+k,-1e-5>(d.py1-this.yi)*(this.yi-d.py2)||-1e-5>(this.py1-this.yi)*(this.yi-this.py2)?this.RoughSegmentRelationConst.SEPARATE:1e-5>i(m)?-1e-5>(this.px1-this.xi)*(this.xi-this.px2)?this.RoughSegmentRelationConst.SEPARATE:this.RoughSegmentRelationConst.INTERSECTS:this.RoughSegmentRelationConst.INTERSECTS):e==f?k==l?this.px1>=h(d.px1,d.px2)&&this.px1<=g(d.py1,d.py2)?(this.xi=this.px1,this.yi=this.py1,this.RoughSegmentRelationConst.INTERSECTS):this.px2>=h(d.px1,d.px2)&&this.px2<=g(d.px1,d.px2)?(this.xi=this.px2,this.yi=this.py2,this.RoughSegmentRelationConst.INTERSECTS):this.RoughSegmentRelationConst.SEPARATE:this.RoughSegmentRelationConst.SEPARATE:(this.xi=(l-k)/(e-f),this.yi=e*this.xi+k,-1e-5>(this.px1-this.xi)*(this.xi-this.px2)||-1e-5>(d.px1-this.xi)*(this.xi-d.px2)?this.RoughSegmentRelationConst.SEPARATE:this.RoughSegmentRelationConst.INTERSECTS)}getLength(){return this._getLength(this.px1,this.py1,this.px2,this.py2)}_getLength(a,b,c,d){var e=c-a,g=d-b;return f(e*e+g*g)}}class l{constructor(a,b,c,d,e,f,g,h){this.top=a,this.bottom=b,this.left=c,this.right=d,this.gap=e,this.sinAngle=f,this.tanAngle=h,1e-4>i(f)?this.pos=c+e:.9999<i(f)?this.pos=a+e:(this.deltaX=(b-a)*i(h),this.pos=c-i(this.deltaX),this.hGap=i(e/g),this.sLeft=new k(c,b,c,a),this.sRight=new k(d,b,d,a))}getNextLine(){if(1e-4>i(this.sinAngle)){if(this.pos<this.right){let a=[this.pos,this.top,this.pos,this.bottom];return this.pos+=this.gap,a}}else if(!(.9999<i(this.sinAngle))){let b=this.pos-this.deltaX/2,c=this.pos+this.deltaX/2,d=this.bottom,e=this.top;if(this.pos<this.right+this.deltaX){for(;b<this.left&&c<this.left||b>this.right&&c>this.right;)if(this.pos+=this.hGap,b=this.pos-this.deltaX/2,c=this.pos+this.deltaX/2,this.pos>this.right+this.deltaX)return null;let f=new k(b,d,c,e);f.compare(this.sLeft)==a().INTERSECTS&&(b=f.xi,d=f.yi),f.compare(this.sRight)==a().INTERSECTS&&(c=f.xi,e=f.yi),0<this.tanAngle&&(b=this.right-(b-this.left),c=this.right-(c-this.left));let g=[b,d,c,e];return this.pos+=this.hGap,g}}else if(this.pos<this.bottom){let a=[this.left,this.pos,this.right,this.pos];return this.pos+=this.gap,a}return null}}class m{line(a,b,c,d,e){let f=this._line(a,b,c,d,e,!0,!1),g=this._line(a,b,c,d,e,!0,!0);return{type:'path',ops:f.concat(g)}}linearPath(a,b,c){const d=(a||[]).length;if(2<d){let e=[];for(let b=0;b<d-1;b++){let d=this._line(a[b][0],a[b][1],a[b+1][0],a[b+1][1],c,!0,!1),f=this._line(a[b][0],a[b][1],a[b+1][0],a[b+1][1],c,!0,!0);e=e.concat(d,f)}if(b){let b=this._line(a[d-1][0],a[d-1][1],a[0][0],a[0][1],c,!0,!1),f=this._line(a[d-1][0],a[d-1][1],a[0][0],a[0][1],c,!0,!0);e=e.concat(b,f)}return{type:'path',ops:e}}return 2===d?this.line(a[0][0],a[0][1],a[1][0],a[1][1],c):void 0}polygon(a,b){return this.linearPath(a,!0,b)}rectangle(a,b,c,d,e){return this.polygon([[a,b],[a+c,b],[a+c,b+d],[a,b+d]],e)}curve(a,b){let c=this._curveWithOffset(a,1*(1+.2*b.roughness),b),d=this._curveWithOffset(a,1.5*(1+.22*b.roughness),b);return{type:'path',ops:c.concat(d)}}ellipse(a,b,c,d,f){const g=2*e/f.curveStepCount;let h=i(c/2),j=i(d/2);h+=this._getOffset(.05*-h,.05*h,f),j+=this._getOffset(.05*-j,.05*j,f);let k=this._ellipse(g,a,b,h,j,1,g*this._getOffset(.1,this._getOffset(.4,1,f),f),f),l=this._ellipse(g,a,b,h,j,1.5,0,f);return{type:'path',ops:k.concat(l)}}arc(a,b,f,g,j,k,l,m,n){let o=a,p=b,q=i(f/2),r=i(g/2);q+=this._getOffset(.01*-q,.01*q,n),r+=this._getOffset(.01*-r,.01*r,n);let s=j,t=k;for(;0>s;)s+=2*e,t+=2*e;t-s>2*e&&(s=0,t=2*e);let u=2*e/n.curveStepCount,v=h(u/2,(t-s)/2),w=this._arc(v,o,p,q,r,s,t,1,n),x=this._arc(v,o,p,q,r,s,t,1.5,n),y=w.concat(x);return l&&(m?(y=y.concat(this._line(o,p,o+q*d(s),p+r*c(s),n,!0,!1)),y=y.concat(this._line(o,p,o+q*d(s),p+r*c(s),n,!0,!0)),y=y.concat(this._line(o,p,o+q*d(t),p+r*c(t),n,!0,!1)),y=y.concat(this._line(o,p,o+q*d(t),p+r*c(t),n,!0,!0))):(y.push({op:'lineTo',data:[o,p]}),y.push({op:'lineTo',data:[o+q*d(s),p+r*c(s)]}))),{type:'path',ops:y}}hachureFillArc(a,b,f,g,h,j,k){let l=a,m=b,n=i(f/2),o=i(g/2);n+=this._getOffset(.01*-n,.01*n,k),o+=this._getOffset(.01*-o,.01*o,k);let p=h,q=j;for(;0>p;)p+=2*e,q+=2*e;q-p>2*e&&(p=0,q=2*e);let r=(q-p)/k.curveStepCount,s=[],t=[];for(let e=p;e<=q;e+=r)s.push(l+n*d(e)),t.push(m+o*c(e));return s.push(l+n*d(q)),t.push(m+o*c(q)),s.push(l),t.push(m),this.hachureFillShape(s,t,k)}solidFillShape(a,b,c){let d=[];if(a&&b&&a.length&&b.length&&a.length===b.length){let f=c.maxRandomnessOffset||0;const g=a.length;if(2<g){d.push({op:'move',data:[a[0]+this._getOffset(-f,f,c),b[0]+this._getOffset(-f,f,c)]});for(var e=1;e<g;e++)d.push({op:'lineTo',data:[a[e]+this._getOffset(-f,f,c),b[e]+this._getOffset(-f,f,c)]})}}return{type:'fillPath',ops:d}}hachureFillShape(a,f,j){let k=[];if(a&&f&&a.length&&f.length){let m=a[0],n=a[0],o=f[0],p=f[0];for(let b=1;b<a.length;b++)m=h(m,a[b]),n=g(n,a[b]),o=h(o,f[b]),p=g(p,f[b]);const i=j.hachureAngle;let q=j.hachureGap;0>q&&(q=4*j.strokeWidth),q=g(q,.1);const r=i%180*(e/180),s=d(r),t=c(r),u=b(r),v=new l(o-1,p+1,m-1,n+1,q,t,s,u);for(let b;null!=(b=v.getNextLine());){let c=this._getIntersectingLines(b,a,f);for(let a=0;a<c.length;a++)if(a<c.length-1){let b=c[a],d=c[a+1];const e=this._line(b[0],b[1],d[0],d[1],j,!0,!1),f=this._line(b[0],b[1],d[0],d[1],j,!0,!0);k=k.concat(e,f)}}}return{type:'path',ops:k}}hachureFillEllipse(a,c,d,g,h){let j=[],k=i(d/2),l=i(g/2);k+=this._getOffset(.05*-k,.05*k,h),l+=this._getOffset(.05*-l,.05*l,h);let m=h.hachureAngle,n=h.hachureGap;0>=n&&(n=4*h.strokeWidth);let o=h.fillWeight;0>o&&(o=h.strokeWidth/2);let p=b(m%180*(e/180)),q=l/k,r=f(q*p*q*p+1),s=q*p/r,t=1/r,u=n/(k*l/f(l*t*(l*t)+k*s*(k*s))/k),v=f(k*k-(a-k+u)*(a-k+u));for(var w=a-k+u;w<a+k;w+=u){v=f(k*k-(a-w)*(a-w));let b=this._affine(w,c-v,a,c,s,t,q),d=this._affine(w,c+v,a,c,s,t,q);const e=this._line(b[0],b[1],d[0],d[1],h,!0,!1),g=this._line(b[0],b[1],d[0],d[1],h,!0,!0);j=j.concat(e,g)}return{type:'path',ops:j}}_getOffset(a,b,c){return c.roughness*(Math.random()*(b-a)+a)}_affine(a,b,c,d,e,f,g){return[-c*f-d*e+c+f*a+e*b,g*(c*e-d*f)+d+-g*e*a+g*f*b]}_line(a,b,c,d,e,g,h){var i=Math.pow;const j=i(a-c,2)+i(b-d,2);let k=e.maxRandomnessOffset||0;100*(k*k)>j&&(k=f(j)/10);const l=k/2,m=.2+.2*Math.random();let n=e.bowing*e.maxRandomnessOffset*(d-b)/200,o=e.bowing*e.maxRandomnessOffset*c/200;n=this._getOffset(-n,n,e),o=this._getOffset(-o,o,e);let p=[];return g&&(h?p.push({op:'move',data:[a+this._getOffset(-l,l,e),b+this._getOffset(-l,l,e)]}):p.push({op:'move',data:[a+this._getOffset(-k,k,e),b+this._getOffset(-k,k,e)]})),h?p.push({op:'bcurveTo',data:[n+a+(c-a)*m+this._getOffset(-l,l,e),o+b+(d-b)*m+this._getOffset(-l,l,e),n+a+2*(c-a)*m+this._getOffset(-l,l,e),o+b+2*(d-b)*m+this._getOffset(-l,l,e),c+this._getOffset(-l,l,e),d+this._getOffset(-l,l,e)]}):p.push({op:'bcurveTo',data:[n+a+(c-a)*m+this._getOffset(-k,k,e),o+b+(d-b)*m+this._getOffset(-k,k,e),n+a+2*(c-a)*m+this._getOffset(-k,k,e),o+b+2*(d-b)*m+this._getOffset(-k,k,e),c+this._getOffset(-k,k,e),d+this._getOffset(-k,k,e)]}),p}_curve(a,c,d){const e=a.length;let f=[];if(3<e){const g=[],b=1-d.curveTightness;f.push({op:'move',data:[a[1][0],a[1][1]]});for(let c=1;c+2<e;c++){const d=a[c];g[0]=[d[0],d[1]],g[1]=[d[0]+(b*a[c+1][0]-b*a[c-1][0])/6,d[1]+(b*a[c+1][1]-b*a[c-1][1])/6],g[2]=[a[c+1][0]+(b*a[c][0]-b*a[c+2][0])/6,a[c+1][1]+(b*a[c][1]-b*a[c+2][1])/6],g[3]=[a[c+1][0],a[c+1][1]],f.push({op:'bcurveTo',data:[g[1][0],g[1][1],g[2][0],g[2][1],g[3][0],g[3][1]]})}if(c&&2===c.length){let a=d.maxRandomnessOffset;f.push({ops:'lineTo',data:[c[0]+this._getOffset(-a,a,d),c[1]+ +this._getOffset(-a,a,d)]})}}else if(3===e)f.push({op:'move',data:[a[1][0],a[1][1]]}),f.push({op:'bcurveTo',data:[a[1][0],a[1][1],a[2][0],a[2][1],a[2][0],a[2][1]]});else if(2===e){let b=this._line(a[0][0],a[0][1],a[1][0],a[1][1],d,!0,!1),c=this._line(a[0][0],a[0][1],a[1][0],a[1][1],d,!0,!0);f=f.concat(b,c)}return f}_ellipse(a,b,f,g,h,i,j,k){const l=this._getOffset(-.5,.5,k)-e/2,m=[];m.push([this._getOffset(-i,i,k)+b+.9*g*d(l-a),this._getOffset(-i,i,k)+f+.9*h*c(l-a)]);for(let n=l;n<2*e+l-.01;n+=a)m.push([this._getOffset(-i,i,k)+b+g*d(n),this._getOffset(-i,i,k)+f+h*c(n)]);return m.push([this._getOffset(-i,i,k)+b+g*d(l+2*e+.5*j),this._getOffset(-i,i,k)+f+h*c(l+2*e+.5*j)]),m.push([this._getOffset(-i,i,k)+b+.98*g*d(l+j),this._getOffset(-i,i,k)+f+.98*h*c(l+j)]),m.push([this._getOffset(-i,i,k)+b+.9*g*d(l+.5*j),this._getOffset(-i,i,k)+f+.9*h*c(l+.5*j)]),this._curve(m,null,k)}_curveWithOffset(a,b,c){const d=[[a[0][0]+this._getOffset(-b,b,c),a[0][1]+this._getOffset(-b,b,c)],[a[0][0]+this._getOffset(-b,b,c),a[0][1]+this._getOffset(-b,b,c)]];for(let e=1;e<a.length;e++)d.push([a[e][0]+this._getOffset(-b,b,c),a[e][1]+this._getOffset(-b,b,c)]),e===a.length-1&&d.push([a[e][0]+this._getOffset(-b,b,c),a[e][1]+this._getOffset(-b,b,c)]);return this._curve(d,null,c)}_arc(a,b,e,f,g,h,i,j,k){const l=h+this._getOffset(-.1,.1,k),m=[];m.push([this._getOffset(-j,j,k)+b+.9*f*d(l-a),this._getOffset(-j,j,k)+e+.9*g*c(l-a)]);for(let n=l;n<=i;n+=a)m.push([this._getOffset(-j,j,k)+b+f*d(n),this._getOffset(-j,j,k)+e+g*c(n)]);return m.push([b+f*d(i),e+g*c(i)]),m.push([b+f*d(i),e+g*c(i)]),this._curve(m,null,k)}_getIntersectingLines(b,c,d){let e=[];for(var f=new k(b[0],b[1],b[2],b[3]),g=0;g<c.length;g++){let b=new k(c[g],d[g],c[(g+1)%c.length],d[(g+1)%c.length]);f.compare(b)==a().INTERSECTS&&e.push([f.xi,f.yi])}return e}}return class{constructor(a,b){this.config=b||{},this.canvas=a,this.ctx=this.canvas.getContext('2d'),this.defaultOptions={maxRandomnessOffset:2,roughness:1,bowing:1,stroke:'#000',strokeWidth:1,curveTightness:0,curveStepCount:9,fill:null,fillStyle:'hachure',fillWeight:-1,hachureAngle:-41,hachureGap:-1},this.config.options&&(this.defaultOptions=this._options(this.config.options))}async lib(){if(!this._renderer)if(window.workly&&!this.config.noWorker){const b=Function.prototype.toString,c=this.config.worklyURL||'https://cdn.jsdelivr.net/gh/pshihn/workly/dist/workly.min.js';let d=`importScripts('${c}');\n${b.call(a)}\n${b.call(k)}\n${b.call(l)}\nself._rendererClass=${b.call(m)}\nworkly.expose(self._rendererClass);`,e=URL.createObjectURL(new Blob([d])),f=workly.proxy(e);this._renderer=await new f}else this._renderer=new m;return this._renderer}async line(a,b,c,d,e){let f=this._options(e),g=await this.lib(),h=await g.line(a,b,c,d,f);this._draw(this.ctx,h,f)}async rectangle(a,b,c,d,e){let f=this._options(e),g=await this.lib();if(f.fill){let e=this.ctx;const h=[a,a+c,a+c,a],i=[b,b,b+d,b+d];if('solid'===f.fillStyle){let a=await g.solidFillShape(h,i,f);this._fill(e,a,f)}else{let a=await g.hachureFillShape(h,i,f);this._fillSketch(e,a,f)}}let h=await g.rectangle(a,b,c,d,f);this._draw(this.ctx,h,f)}async ellipse(a,b,c,d,e){let f=this._options(e),g=await this.lib();if(f.fill)if('solid'===f.fillStyle){let e=await g.ellipse(a,b,c,d,f);this._fill(this.ctx,e,f)}else{let e=await g.hachureFillEllipse(a,b,c,d,f);this._fillSketch(this.ctx,e,f)}let h=await g.ellipse(a,b,c,d,f);this._draw(this.ctx,h,f)}async circle(a,b,c,d){return await this.ellipse(a,b,c,c,d)}async linearPath(a,b){let c=this._options(b),d=await this.lib(),e=await d.linearPath(a,!1,c);this._draw(this.ctx,e,c)}async polygon(a,b){let c=this._options(b),d=await this.lib();if(c.fill){let b=[],e=[];for(let c of a)b.push(c[0]),e.push(c[1]);if('solid'===c.fillStyle){let a=await d.solidFillShape(b,e,c);this._fill(this.ctx,a,c)}else{let a=await d.hachureFillShape(b,e,c);this._fillSketch(this.ctx,a,c)}}let e=await d.linearPath(a,!0,c);this._draw(this.ctx,e,c)}async arc(a,b,c,d,e,f,g,h){let i=this._options(h),j=await this.lib();if(g&&i.fill)if('solid'===i.fillStyle){let g=await j.arc(a,b,c,d,e,f,!0,!1,i);this._fill(this.ctx,g,i)}else{let g=await j.hachureFillArc(a,b,c,d,e,f,i);this._fillSketch(this.ctx,g,i)}let k=await j.arc(a,b,c,d,e,f,g,!0,i);this._draw(this.ctx,k,i)}async curve(a,b){let c=this._options(b),d=await this.lib(),e=await d.curve(a,c);this._draw(this.ctx,e,c)}_options(a){return a?Object.assign({},this.defaultOptions,a):this.defaultOptions}_draw(a,b,c){a.save(),a.strokeStyle=c.stroke,a.lineWidth=c.strokeWidth,this._drawToContext(a,b),a.restore()}_fillSketch(a,b,c){let d=c.fillWeight;0>d&&(d=c.strokeWidth/2),a.save(),a.strokeStyle=c.fill,a.lineWidth=d,this._drawToContext(a,b),a.restore()}_fill(a,b,c){a.save(),a.fillStyle=c.fill,b.type='fillPath',this._drawToContext(a,b,c),a.restore()}_drawToContext(a,b){if('path'===b.type||'fillPath'===b.type){a.beginPath();for(let c of b.ops){const b=c.data;switch(c.op){case'move':a.moveTo(b[0],b[1]);break;case'bcurveTo':a.bezierCurveTo(b[0],b[1],b[2],b[3],b[4],b[5]);break;case'lineTo':a.lineTo(b[0],b[1]);}}'fillPath'===b.type?a.fill():a.stroke()}}}}();